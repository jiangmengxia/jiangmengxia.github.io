<!--
 * @Author: jiangmengxia jiangmengxia@qq.com
 * @Date: 2024-09-19 20:37:52
 * @LastEditors: jiangmengxia jiangmengxia@qq.com
 * @LastEditTime: 2024-09-19 22:30:31
 * @FilePath: /jiangmengxia.github.io/react-router/demo/index.html
 * @Description: Description
-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>手写实现redux的Provider&Connect方法</title>
    <!-- 引入Babel编译器，用于将JSX转换为JavaScript -->
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
    <!-- 引入React和React DOM库 -->
    <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const router = {
        routes: [],
        addRoute(route) {
          this.routes.push(route);
        },
        match(pathname) {
          for (let i = 0; i < this.routes.length; i++) {
            const route = this.routes[i];
            if (route.path === pathname) {
              return route;
            }
          }
          return null;
        },
      };
      const { pathname } = window.location;
      const { createContext, useEffect, Fragment } = React;

      let PATH_MAP = {};

      const getPathMap = (children) => {
        PATH_MAP = {};
        getRouteTree(children);
        console.log("PATH_MAP", PATH_MAP);
      };
      const getRouteTree = (children, parentPath = "") => {
        if (children.type === Route) {
          const path = children.props.path;
          const component = children.props.component;
          PATH_MAP[`${parentPath}${path}`] = {
            match: `${parentPath}${path}`,
            component,
            path,
          };
          if (children.props.children) {
            getRouteTree(children.props.children, `${parentPath}${path}`);
          }
        } else if (Array.isArray(children)) {
          children.forEach((child) => {
            getRouteTree(child, parentPath);
          });
        }
      };
      const getPathMatch = (path, component) => {
        console.log("PATH_MAP", PATH_MAP);
        return Object.keys(PATH_MAP).find((key) => {
          console.warn(
            `path ${path === PATH_MAP[key].path}, component ${
              component === PATH_MAP[key].component
            }`
          );
          return (
            PATH_MAP[key].path === path && PATH_MAP[key].component === component
          );
        });
      };

      function Router({ children }) {
        const RouterProvider = createContext();
        getPathMap(children);
        return (
          <RouterProvider.Provider value={router}>
            {children}
          </RouterProvider.Provider>
        );
      }

      function Route({ children, path, component: Component }) {
        const match = getPathMatch(path, Component);
        return (
          <Fragment>
            <Component>{children}</Component>
          </Fragment>
        );
      }

      function Home({ children }) {
        return (
          <ul>
            <li>HOME</li>
            {children}
          </ul>
        );
      }

      function About() {
        return <li>About</li>;
      }

      function Inbox({ children }) {
        return (
          <li>
            Inbox
            {children}
          </li>
        );
      }

      function Message() {
        return <li>Message</li>;
      }

      function App() {
        return (
          <Router>
            <Route path="/" component={Home}>
              <Route path="about" component={About} />
              <Route path="inbox" component={Inbox}>
                <Route path="messages/:id" component={Message} />
              </Route>
            </Route>
          </Router>
        );
      }
      ReactDOM.render(<App />, document.getElementById("root"));
    </script>
  </body>
</html>
